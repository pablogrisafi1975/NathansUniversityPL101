<html>
<head>
  <meta charset="utf-8">
  <title>Mocha Tests</title>
  <link rel="stylesheet"
    href="http://nathansuniversity.com/css/mocha.css" />
  <script src=
    "http://nathansuniversity.com/js/jquery-1.7.1.min.js">
  </script>
  <script src=
    "http://nathansuniversity.com/js/chai.js">
  </script>
  <script src="http://nathansuniversity.com/js/mocha.js">
  </script>
  <script>mocha.setup('tdd')</script>
  <script>
var expect = chai.expect;    
var assert = chai.assert;

// A half-baked implementation of evalScheem
var evalScheem = function (expr, env) {
    // Numbers evaluate to themselves
    if (typeof expr === 'number') {
        return expr;
    }
    if (typeof expr === 'string') {
        return env[expr];
    }	
    // Look at head of list for operation
    switch (expr[0]) {
        case '+':
        case '-':
        case '*':
        case '/':
			validateExprSize(expr, 3);			
			var a = validateExprIsNumeric(expr, 1, env);
			var b = validateExprIsNumeric(expr, 2, env);
			switch(expr[0]){
				case '+':
					return a + b;
				case '-':
					return a - b;
				case '*':
					return a * b;
				case '/':
					return a / b;  			
			}
        case 'define':
			validateExprSize(expr, 3);
			if(typeof env[expr[1]] !== 'undefined'){
				throw new Error(expr[1] + ' already defined' );
			}
            env[expr[1]] = evalScheem(expr[2], env);
            return 0;
        case 'set!':
			validateExprSize(expr, 3);			
			if(typeof env[expr[1]] === 'undefined'){
				throw new Error(expr[1] + ' not defined' );
			}		
            env[expr[1]] = evalScheem(expr[2], env);
            return 0;  
        case 'begin':    
			if(expr.length < 2){
				throw new Error(expr + ' must have at least one extra element');
			}		
            var result = 0;
            for(var i = 1; i < expr.length; i++){
                result =  evalScheem(expr[i], env);
            }
            return result;			
        case 'cons':
			validateExprSize(expr, 3);		
			var list = validateExprIsList(expr, 2, env);
            return [evalScheem(expr[1], env)].concat(list);			
        case 'car':
			validateExprSize(expr, 2);		
			var list = validateExprIsList(expr, 1, env);
            return list[0];  
        case 'cdr':
			validateExprSize(expr, 2);		
			var list = validateExprIsList(expr, 1, env);		
            return list.slice(1);      
        case '=':
			validateExprSize(expr, 3);		
            var areEqual = (evalScheem(expr[1], env) === evalScheem(expr[2], env));
            return areEqual ? '#t' :'#f';
        case 'if':
			validateExprSize(expr, 4);		
			var result = evalScheem(expr[1], env);
			validateBoolean(result);
            return result === '#t' ? evalScheem(expr[2], env) : evalScheem(expr[3], env);
        case '<':
			validateExprSize(expr, 3);	
			var a = validateExprIsNumeric(expr, 1, env);
			var b = validateExprIsNumeric(expr, 2, env);			
            return  a < b ? '#t' : '#f';   			
        case 'quote':
            return expr[1];
    }
	function validateExprSize(expr, expectedLength){
		if(expr.length !== expectedLength){
			throw new Error(expr + ' must have ' + (expectedLength - 1) + ' operands');
		}
	}
	function validateBoolean(value){
		if(value !== '#t' && value !== '#f' ){
			throw new Error(value + ' must be #t o #f');
		}
	}	
	function validateExprIsList(expr, index, env){
		var list = evalScheem(expr[index], env);
		if(!Array.isArray(list)){
			throw new Error(list + ' should be a list');
		}
		return list;
	}	
	function validateExprIsNumeric(expr, index, env){
		var number = evalScheem(expr[index], env);
		if (typeof number !== 'number' ){
			throw new Error('value: ' + number + ' is not a number' );
		}
		return number;
	}		
};
/*
    Numbers done
	Add minus and time and div (no test for div, but done)
    Variable references done
    begin done
    quote done
	cons, car, cdr done
    =, done
	if, done
	<, done

*/

// Some unit tests

suite('number', function() {
    test('integer', function() {
        assert.deepEqual(
            evalScheem(3, {}),
            3
        );
    });
    test('float', function() {
        assert.deepEqual(
            evalScheem(4.4, {}),
            4.4
        );
    });
    test('negative', function() {
        assert.deepEqual(
            evalScheem(-5, {}),
            -5
        );
    });
});

suite('add', function() {
    test(' 2 and 2', function() {
        assert.deepEqual(
            evalScheem(['+', 2, 2], {}),
            4
        );
    });
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['+', 3, 5], {}),
            8
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['+', 3, ['+', 2, 2]], {}),
            7
        );
    });
	test('a dog and a cat', function() {
		expect(function () {
			evalScheem(['+', 'dog', 'cat'], {});
		}).to.throw();
	});	
	test('a dog and 2', function() {
		expect(function () {
			evalScheem(['+', 'dog', 2], {});
		}).to.throw();
	});		
	test('3 and a cat', function() {
		expect(function () {
			evalScheem(['+', 3, 'cat'], {});
		}).to.throw();
	});		
	test('2 and a "2"', function() {
		expect(function () {
			evalScheem(['+', 2, '2'], {});
		}).to.throw();
	});	
	test('1 and a 2 and 3', function() {
		expect(function () {
			evalScheem(['+', 1, 2, 3], {});
		}).to.throw();
	});		
	test('nothing to add', function() {
		expect(function () {
			evalScheem(['+'], {});
		}).to.throw();
	});			
})

suite('minus', function() {
    test(' 2 and 2', function() {
        assert.deepEqual(
            evalScheem(['-', 2, 2], {}),
            0
        );
    });
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['-', 3, 5], {}),
            -2
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['-', 3, ['-', 2, 2]], {}),
            3
        );
    });
})

suite('times', function() {
    test(' 2 and 2', function() {
        assert.deepEqual(
            evalScheem(['*', 2, 2], {}),
            4
        );
    });
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['*', 3, 5], {}),
            15
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['*', 3, ['*', 2, 2]], {}),
            12
        );
    });
})

suite('variables', function(){
	
    test('x test', function() {
		var env = {x:2, y:3, z:10};
        assert.deepEqual(
            evalScheem('x', env),
            2
        );
    });		
    test('evaluation of define test', function(){
		var env = {x:2, y:3, z:10};
		var tmp = evalScheem(['define', 'a', 5], env);
		assert.deepEqual(tmp, 0);
	});	
	test('define already defined', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['define', 'x', 5], env);
		}).to.throw();
	});		
    test('define to list', function(){
		var env = {x:2, y:3, z:10};
		var tmp = evalScheem(['define', 'a', ['quote', [5, 6, 7]]], env);
		assert.deepEqual(env, {x:2, y:3, z:10, a:[5,6,7]});
	});		
	test('define too many', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['define', 'a', 5, 6, 7], env);
		}).to.throw();
	});		
 	test('define too few', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['define', 'a'], env);
		}).to.throw();
	});	
	test('set! not defined', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['set!', 'yyyyy', 5], env);
		}).to.throw();
	});	
	test('set! too many', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['set!', 'a', 5, 6, 7], env);
		}).to.throw();
	});		
 	test('set! too few', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['set!', 'a'], env);
		}).to.throw();
	});		
    test('(set! y (+ x 1)) test', function(){
		var env = {x:2, y:3, z:10};
		var tmp = evalScheem(['set!', 'y', ['+', 'x', 1]], env);
		assert.deepEqual(env, {x:2, y:3, z:10});
	});		
})

suite('begin', function(){
    test('(begin 99) test', function(){
		assert.deepEqual(evalScheem(['begin', 99], {}), 99);
	});
    test('(begin 1 2 3) test', function(){
		assert.deepEqual(evalScheem(['begin', 1, 2, 3], {}), 3);
	});
    test('(begin (+ 2 2) test', function(){
		assert.deepEqual(evalScheem(['begin', ['+', 2, 2]], {}), 4);
	});	
    test('(begin x y x) test', function(){
		assert.deepEqual(evalScheem(['begin', 'x', 'y', 'x'], {x:1, y:2}), 1);
	});	
    test('(begin (set! x 5) (set! x (+ y x) x)) test', function(){
		assert.deepEqual(evalScheem(['begin', ['set!', 'x', 5], ['set!', 'x', ['+', 'y', 'x']], 'x'], {x:1, y:2}), 7);
	});	
 	test('begin too few', function() {
		expect(function () {
			evalScheem(['begin'], {});
		}).to.throw();
	});		
});

suite('quote', function() {
    test('a number', function() {
        assert.deepEqual(
            evalScheem(['quote', 3], {}),
            3
        );
    });
    test('an atom', function() {
        assert.deepEqual(
            evalScheem(['quote', 'dog'], {}),
            'dog'
        );
    });
    test('a list', function() {
        assert.deepEqual(
            evalScheem(['quote', [1, 2, 3]], {}),
            [1, 2, 3]
        );
    });
});

suite('list operations', function(){
    test('(cons 1 \'(2 3)) test', function() {
        assert.deepEqual(
            evalScheem(['cons', 1, ['quote', [2, 3]]], {}),
			[1, 2, 3]
        );
    });
    test('(cons \'(1 2) \'(3 4)) test', function() {
        assert.deepEqual(
            evalScheem(['cons', ['quote', [1, 2]], ['quote', [3, 4]]], {}),
			[[1, 2], 3, 4]
        );
    });	
 	test('cons no list', function() {
		expect(function () {
			evalScheem(['cons', 1, 3], {});
		}).to.throw();
	});
	test('cons too many', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['cons', 1, ['quote', [2, 3]], ['quote', [2, 3]]] , {})
		}).to.throw();
	});		
 	test('cons too few', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['cons', 1], {})
		}).to.throw();
	});		
    test('(car \'((1 2) 3 4)) test', function() {
        assert.deepEqual(
            evalScheem(['car', ['quote', [[1, 2], 3, 4]]], {}),
			[1, 2]
        );
    });	
 	test('car no list', function() {
		expect(function () {
			evalScheem(['car', 1], {});
		}).to.throw();
	});	
 	test('car empty list', function() {
		expect(function () {
			evalScheem(['car', []], {});
		}).to.throw();
	});		
	test('car too many', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['car', ['quote', [2, 3]], ['quote', [2, 3]]] , {})
		}).to.throw();
	});		
 	test('car too few', function() {
		var env = {x:2, y:3, z:10};
		expect(function () {
			evalScheem(['car'], {})
		}).to.throw();
	});	
    test('(cdr \'((1 2) 3 4)) test', function() {
        assert.deepEqual(
            evalScheem(['cdr', ['quote', [[1, 2], 3, 4]]], {}),
			[3, 4]
        );
    });
    test('(cdr \'(2)) test', function() {
        assert.deepEqual(
            evalScheem(['cdr', ['quote', [2]]], {}),
			[]
        );
    });	
 	test('cdr no list', function() {
		expect(function () {
			evalScheem(['cdr', 1], {});
		}).to.throw();
	});	
 	test('cdr empty list', function() {
		expect(function () {
			evalScheem(['cdr', []], {});
		}).to.throw();
	});	
	test('cdr too many', function() {
		expect(function () {
			evalScheem(['cdr', ['quote', [2, 3]], ['quote', [2, 3]]] , {})
		}).to.throw();
	});		
 	test('cdr too few', function() {
		expect(function () {
			evalScheem(['cdr'], {})
		}).to.throw();
	});		
});	

suite('equal and if', function(){
    test('(if (= 1 1) 2 3) test', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 1, 1], 2, 3], {}), 2
        );
    });
	test('equal too many', function() {
		expect(function () {
			evalScheem(['=', 1, 2, 4] , {})
		}).to.throw();
	});		
 	test('equal too few', function() {
		expect(function () {
			evalScheem(['='], {})
		}).to.throw();
	});		
	
    test('(if (= 1 0) 2 3) test', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 1, 0], 2, 3], {}), 3
        );
    });	
	
    test('(if (= 1 1) 2 error) test', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 1, 1], 2, 'error'], {}), 2
        );
    });		
	
    test('(if (= 1 1) error 3) test', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 1, 0], 'error', 3], {}), 3
        );
    });		
	
    test('(if (= 1 1) (if (= 2 3) 10 11) 12) test', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 1, 1], ['if', ['=', 2, 3], 10, 11], 12], {}), 11
        );
    });		
	test('if too many', function() {
		expect(function () {
			 evalScheem(['if', ['=', 1, 0], 2, 3, 4], {})
		}).to.throw();
	});		
 	test('if too few', function() {
		expect(function () {
			 evalScheem(['if', ['=', 1, 0], 2], {})
		}).to.throw();
	});
	test('if not boolean', function() {
		expect(function () {
			 evalScheem(['if', 4444, 2, 3], {})
		}).to.throw();
	});		
});

suite('minor', function(){
    test('(< 2 2) test', function() {
        assert.deepEqual(
            evalScheem(['<', 2, 2], {}), '#f'
        );
    });
    test('(< 2 3) test', function() {
        assert.deepEqual(
            evalScheem(['<', 2, 3], {}), '#t'
        );
    });	
    test('(< (+ 1 1) (+ 2 3)) test', function() {
        assert.deepEqual(
            evalScheem(['<', ['+', 1, 1], ['+', 2, 3]], {}), '#t'
        );
    });		
	test('minor too many', function() {
		expect(function () {
			 evalScheem(['<', 2, 3, 4], {})
		}).to.throw();
	});		
 	test('minor too few', function() {
		expect(function () {
			 evalScheem(['<', 2], {})
		}).to.throw();
	});
 	test('minor not numeric', function() {
		expect(function () {
			 evalScheem(['<', 2 , 'dog'], {})
		}).to.throw();
	});	
 	test('minor not numeric', function() {
		expect(function () {
			 evalScheem(['<', 'dog', 3], {})
		}).to.throw();
	});	
});


  </script>
  <script>
    $(function(){
      mocha.run();
    });
  </script>
</head>
<body>
  <div id="mocha"></div>
</body>
</html>
